<!doctype html>
<html>
    <head>
        <meta charset='utf-8'>
        <title>audio, freshly-squeezed ‚ô™ ‚ô´ ‚ô™ ‚ô¨üîä üçã  üçã  üçã citrus.</title>

        <!--
            CSS
        -->
        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/colors.css">
        <link rel="stylesheet" href="css/style.css">

        <!--
            JS
        -->
        <script src="dragdrop.min.js" async></script>
        <script src="webtorrent.min.js" async></script>

        <!--
            MORE JS
        -->
        <script src="waveform.js" async></script>

        <!--
            Avgrund!
        -->
        <link rel="stylesheet" href="css/avgrund.css">
        <script src="avgrund.js" async></script>

        <!--
            codrops!
        -->
        <link rel="stylesheet" href="css/cbutton.css">

    </head>
    <body>
        <header>
            <div style="display:flex;align-items:center">
                <!--
                    lemon
                -->
                <div style="flex:0 1;">
                    <div onclick="aboutModal()" class="cbutton cbutton--effect-sanja" style="margin-top:3px;">
                        <img src="lemon.svg" class="citrus__logo">
                    </div>
                </div>

                <div style="flex:1;align-self:flex-start">
                    <!--
                        scary red text
                    -->
                    <p id="errorMessage"></p>
                </div>

                <div style="flex:0 1;">
                    <!--
                        arrow
                    -->
                    <div class="cbutton cbutton--effect-sanja" style="margin-top:-16px;">
                        <label>
                            <svg style="width:32px;height:32px;fill:#1e181a" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <g>
                                    <path d="M54,37.7V91c0,2.2-1.8,4-4,4s-4-1.8-4-4V37.7L26.7,54.9c-1.7,1.5-4.2,1.4-5.7-0.3 s-1.3-4.2,0.3-5.6l26-23.1l2.7-2.4l2.7,2.4l26,23.1c1.7,1.5,1.8,4,0.3,5.6c-1.5,1.7-4,1.8-5.6,0.3L54,37.7L54,37.7z M76,13 c2.2,0,4-1.8,4-4s-1.8-4-4-4H24c-2.2,0-4,1.8-4,4s1.8,4,4,4H76L76,13z"/>
                                </g>
                            </svg>
                            <input type="file" style="display:none">
                        </label>
                    </div>
                </div>
            </div>
        </header>

        <main class="avgrund-contents">Loading...</main>

        <footer>
            <hr>
            <!--
                knob
            -->
            <input type="range" class="citrus__volume" title="adjust volume" min="0" max="100" step="1" value="75">
        </footer>

        <!--
            supr√™me
        -->
        <template id="supr√™me">
            <article class="citrus__supr√™me citrus__supr√™me--paused">
                <div class="citrus__supr√™me-inner-row">
                    <div class="citrus__supr√™me-playpause-column">
                        <svg class="citrus__supr√™me-playpause-button play" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg" >
                            <path d="M50,0C22.4,0,0,22.4,0,50s22.4,50,50,50s50-22.4,50-50S77.6,0,50,0z M38.7,72.4V27.2l34.9,22.6L38.7,72.4z"/>
                        </svg>
                        <svg class="citrus__supr√™me-playpause-button pause" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50,0C22.4,0,0,22.4,0,50s22.4,50,50,50s50-22.4,50-50S77.6,0,50,0z M45,72.4H33V27.2h12V72.4z M67,72.4H55 V27.2h12V72.4z"/>
                        </svg>
                    </div>
                    <div class="citrus__supr√™me-waveform-column not-playing">
                        <h1 class="citrus__supr√™me-title">
                            <a href="#" class="magnetURI">
                                <img src="magnet.svg">
                                <span class="fileName"></span>
                            </a>
                            <time class="citrus__supr√™me-createdat-time createdAt" data-value></time>
                        </h1>
                        <div class="waveformBox" style="position:relative;overflow:hidden;white-space:nowrap;width:100%">
                            <!-- left: position + "%"; -->
                            <div data-style-property="left" style="position:absolute;left:0%;height:100%;">
                                <div class="slider"></div>
                            </div>

                            <!-- left: (position - 100) + "%"; -->
                            <div data-style-property="left" data-invert-position="1" style="display:inline-block;width:100%;position:relative;vertical-align:bottom;left:0%;overflow:hidden">
                                <!-- right: (position - 100) + "%"; -->
                                <div data-style-property="right" data-invert-position="1" style="position:relative;right:0%;text-align:center">
                                    <!-- "top" image -->
                                    <img class="waveform--yellow">
                                </div>
                            </div>

                            <!-- left: (position - 100) + "%"; -->
                            <div data-style-property="left" data-invert-position="1" style="display:inline-block;width:100%;position:relative;vertical-align:bottom;left:0%;overflow:hidden">
                                <!-- right: position + "%"; -->
                                <div data-style-property="right" style="position:relative;right:0%;text-align:center">
                                    <!-- "bottom" image -->
                                    <img class="waveform--black">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="citrus__supr√™me-info"><small class="torrent">(0 peers online)</small><time class="duration" data-value></time></div>
            </article>
        </template>

        <!--
            share
        -->
        <template id="uploadAndShare">
            <aside class="avgrund-popup">
                <input autofocus required placeholder="DJ Unknown - &quot;untitled (unReleased Mix)&quot;" name="fileName">
                <!-- <textarea disabled placeholder="shout out to you, i'm sending a shoutout to all the mofherf** in them after-hour spots..."></textarea> -->
                <!-- <input disabled placeholder="#yoloswag"> -->
                <div style="display:flex">
                    <button class="ok cbutton cbutton--effect-sanja">OK</button>
                    <button class="cancel cbutton cbutton--effect-sanja">Cancel</button>
                </div>
            </aside>
        </template>

        <!--
            about
        -->
        <template id="about">
            <aside class="avgrund-popup">
                <h1>citrus.audio</h1>
                <p>freshly-squeezed</p>
            </aside>
        </template>

        <!--
            needed for Avgrund
        -->
        <div class="avgrund-cover"></div>

        <script>
// dummies
window.aboutModal = () => {}

// int main(void) {
window.addEventListener("load", () => {

    //
    // utility functions
    //

    // stamps out a <template>
    let getTemplate = (id) => document.getElementById(id).content.cloneNode(true);

    // displays a box
    let openModal = (id) => {
        let modalId = id+"Modal";
        if(!document.getElementById(modalId)) {
            let tpl = getTemplate(id);
            tpl.firstElementChild.setAttribute("id", modalId);
            document.body.appendChild(tpl);
        }
        Avgrund.show("#"+modalId);
    };

    window.aboutModal = () => openModal("about");

    // unique ids for things
    let q = () => parseInt(Math.pow(2,32)*Math.random(),10).toString(16);
    let uniqid = () => `uniqid-${q()+q()+q()+q()}`;

    // format date, e.g. "1 hour ago"
    let fdate = (date) => {
        let diff = ( (new Date()).getTime() - date.getTime() ) / 1000;

        let unit = 'second';

        switch(true) {
        case (diff < 15):
            return 'just now!';
        case (diff > 31536000): diff /= 31536000; unit = 'year'; break;
        case (diff > 2592000): diff /= 2592000; unit = 'month'; break;
        case (diff > 604800): diff /= 604800; unit = 'week'; break;
        case (diff > 86400): diff /= 86400; unit = 'day'; break;
        case (diff > 3600): diff /= 3600; unit = 'hour'; break;
        case (diff > 60): diff /= 60; unit = 'minute'; break;
        }

        diff |= 0;
        return `${diff} ${unit}${diff == 1 ? '' : 's'} ago`;
    };

    // maybe I should import a library for this instead ...
    let zeroPad = (x) => `${x < 10 ? '0' : ''}${x}`;

    // format duration, e.g. "01m:25s"
    let fduration = (s) => {
        let h = parseInt(s / 3600, 10);
        s %= 3600;
        let m = parseInt(s / 60, 10);
        s %= 60;
        return `${h > 0 ? zeroPad(h)+'h:' : ''}${zeroPad(m)}m:${zeroPad(s)}s`;
    };

    // the penguin of doom
    let rand = (min, max) => Math.floor(Math.random() * (max - min)) + min;

    //
    // they might be webcomponents
    //

    // shows red text at the top of page
    let errorMessageElement = document.getElementById("errorMessage");
    window.errorMessage = (msg) => {
        console.error(msg);
        errorMessageElement.innerHTML = msg;
        errorMessageElement.classList.remove("fadeout");
        setTimeout(()=>errorMessageElement.classList.add("fadeout"),2000);
    };
    errorMessageElement.addEventListener("click", () => {
        errorMessageElement.classList.add("fadeout");
        errorMessageElement.innerHTML = "";
    });

    // waveform box
    // (useful comment, I know)
    let inAD2101WarWasBeginning = (containerElement) => {
        const minDistance = 0;
        const maxAngle = Infinity;
        const DEGREES_IN_RADIAN = 180 / Math.PI;

        let state = {
            x: NaN,
            y: NaN,
            isDragging: false,
            position: 0
        };

        function updatePosition(e) {
            if(containerElement.disabled) return;

            [].forEach.call(containerElement.querySelectorAll("[data-style-property]"), function(childElement) {
                var pos = (childElement.dataset.invertPosition ? state.position - 1 : state.position).toPrecision(6) * 100;
                childElement.style[childElement.dataset.styleProperty] = pos+"%";
            });

            containerElement.dispatchEvent(new Event("update", {detail:{event:e,position:state.position}}));
        };

        function takeoffeveryZig(e) {
            if(e) e.preventDefault();
            const isTouch = 'touches' in e;

            let pageX, pageY;
            if(isTouch) {
                pageX = e.touches[0].pageX;
                pageY = e.touches[0].pageY;
            } else {
                pageX = e.pageX;
                pageY = e.pageY;
            }

            state.x = pageX;
            state.y = pageY;

            document.addEventListener('mousemove', moveZig);
            document.addEventListener('touchmove', moveZig);
            document.addEventListener('mouseup', forgreatJustice);
            document.addEventListener('touchend', forgreatJustice);
        };

        function moveZig(e) {
            const isTouch = 'touches' in e;

            let pageX, pageY;
            if(isTouch) {
                pageX = e.touches[0].pageX;
                pageY = e.touches[0].pageY;
            } else {
                pageX = e.pageX;
                pageY = e.pageY;
            }

            if(!state.isDragging && isTouch) {
                const dx = state.x - pageX;
                const dy = state.y - pageY;

                const angle = Math.atan(dy/dx) * DEGREES_IN_RADIAN;
                const distance = Math.sqrt(dx * dx + dy * dy);

                let isDragging = distance >= minDistance;
                if(isDragging && Math.abs(angle) > maxAngle) {
                    // They're trying to scroll vertically
                    forgreatJustice();
                    return;
                } else if(!isDragging) {
                    return;
                }
                state.isDragging = isDragging;
            }

            const rect = containerElement.getBoundingClientRect();
            state.position = Math.max(Math.min( ((pageX - rect.left) / rect.width) , 1), 0);
            updatePosition(e);
        };

        function forgreatJustice() {    
            document.removeEventListener('mousemove', moveZig);
            document.removeEventListener('touchmove', moveZig);
            document.removeEventListener('mouseup', forgreatJustice);
            document.removeEventListener('touchend', forgreatJustice);

            state.isDragging = false;
            state.x = NaN;
            state.y = NaN;
            updatePosition(e);
        };

        function youknowwhatyoudoing(e) {
            takeoffeveryZig(e);
            moveZig(e);
        };

        containerElement.ondragstart = takeoffeveryZig;
        containerElement.ontouchstart = youknowwhatyoudoing;
        containerElement.onmousedown = youknowwhatyoudoing;
        containerElement.ondrag = moveZig;
        containerElement.ondragend = forgreatJustice;
        containerElement.ontouchend = forgreatJustice;
        containerElement.onmouseup = forgreatJustice;

        // set position to 0 on init
        updatePosition();
        // disable on first run, adding audio element enables
        //containerElement.disabled = true;
        // provide hook to update position
        containerElement.setPosition = (p) => {
            state.position = p;
            updatePosition();
        };
    };

    // attaches new segments 
    //xxx: needs some love
    let mainElement = document.querySelector("main");

    // belongs in gimmicks:
    mainElement.onscroll = () => {
        if(mainElement.scrollTop === 0) {
            mainElement.style.boxShadow = "none";
        } else {
            mainElement.style.boxShadow = "0px 10px 10px -5px rgb(204, 204, 204) inset";
        }
    };

    let client = new WebTorrent();                        
    let addChild = (data) => {

        let fileName = data.fileName;
        let magnetURI = data.magnetURI;
        let waveformURI = data.waveformURI;
        let duration = data.duration;
        let createdAt = data.createdAt;

        let tpl = getTemplate("supr√™me");

        let articleElement = tpl.querySelector('article');
        let fileNameElement = tpl.querySelector('.fileName');
        let magnetURIElement = tpl.querySelector('.magnetURI');
        let waveformURIElement = tpl.querySelector('.waveformURI');
        let durationElement = tpl.querySelector('.duration');
        let createdAtElement = tpl.querySelector('.createdAt');
        let playpauseElement = tpl.querySelector('.citrus__supr√™me-playpause-column'); 
        let waveformBoxElement = tpl.querySelector('.waveformBox');

        let uuid = uniqid();
        articleElement.setAttribute("id", uuid);

        playpauseElement.addEventListener("click", (evt) => {
            articleElement.classList.toggle("citrus__supr√™me--paused");
            let audioElement = articleElement.querySelector("audio");
            if(!audioElement) {
                client.add(magnetURI, (torrent) => {
                    torrent.files[0].appendTo(`#${uuid}`, (err, audioElement) => {
                        if(err) {
                            errorMessage(err.message);
                            return;
                        }
                        audioElement.addEventListener("timeupdate", () => {
                            waveformBoxElement.setPosition(audioElement.currentTime / duration);
                        });
                        waveformBoxElement.addEventListener("update", (e) => {
                            if(typeof e.detail.event !== "undefined") {
                                audioElement.currentTime = duration * e.detail.position;
                            }
                        });
                    });
                });
            } else {
                if(audioElement.paused) {
                    audioElement.play();
                    waveformBoxElement.classList.remove("not-playing");
                } else {
                    audioElement.pause();
                    waveformBoxElement.classList.add("not-playing");
                }
            }        
        });
 
        fileName.innerHTML = data.fileName;
        magnetURI.href = data.magnetURI;

        let createdAtDate = new Date(createdAt);
        createdAtElement.innerHTML = fdate(createdAtDate);
        createdAtElement.dataset.value = createdAt;
        createdAtElement.setAttribute("title", createdAtDate.toLocaleString());

        durationElement.innerHTML = fduration(duration);
        durationElement.dataset.value = duration;

        new Promise((resolve) => {
            resolve({
                yellow: getWaveformDataURI(waveformURI, duration, "#fef200"),
                black:  getWaveformDataURI(waveformURI, duration, "#1e181a")
            });
        }).then((waveformImages) => {
            waveformBoxElement.querySelector('.waveform--yellow').src = waveformImages.yellow;
            waveformBoxElement.querySelector('.waveform--black').src  = waveformImages.black;
            inAD2101WarWasBeginning(waveformBoxElement);
        });

        mainElement.appendChild(tpl);
    };

    //
    // websocket
    //

    mainElement.innerHTML = "Opening websocket...";
    window.addEventListener("WebSocketReady", () => mainElement.innerHTML = "");

    let sendPayload;
    let wsError = () => {
        errorMessage("Couldn't connect to websocket.");
        mainElement.innerHTML = "x_x";
    };
    try {
        let ws = new WebSocket("ws://" + location.host + ":12345/");
        ws.onopen = () => {
            sendPayload = (data) => ws.send(JSON.stringify(data));
            window.dispatchEvent(new Event("WebSocketReady"));
        };
        ws.onmessage = (evt) => addChild(JSON.parse(evt.data));
        ws.onerror = (evt) => wsError()
    } catch(err) {
        console.error(err.message);
        wsError();
    }

    //
    // magic
    //

    const validMimetypes = /^audio\/(x\-)?((mp((e)?g(audio|3)?|3))|wav|ogg)$/;

    let doUpload = function(files) {

        if(!files.length) return;
        if(files.length > 1) {
            errorMessage("One file at a time, please!");
            return;
        }

        if("video/ogg" !== files[0].type && !validMimetypes.test(files[0].type)) {
            errorMessage(`MP3, OGG, or WAV only! Yell at ${ "chrome" in window ? "google" : "mozApps" in navigator ? "mozilla" : "whoever makes your browser" } to support ${files[0].type}`);
            return;
        }
        
        openModal("uploadAndShare");

        let uploadAndShareModal = document.querySelector("#uploadAndShareModal");
        let fileNameInput = uploadAndShareModal.querySelector("input[name='fileName']");
        let okButton = uploadAndShareModal.querySelector("button.ok");
        let cancelButton = uploadAndShareModal.querySelector("button.cancel");

        fileNameInput.value = files[0].name.split(".").reverse().filter((v,k)=>k).reverse().join(".") || "";

        setTimeout(()=>fileNameInput.focus(), 500);

        let metadata = {
            fileName: "",
            magnetURI: "",
            waveformURI: "",
            duration: 0
        };

        let promptedTheUser = new Promise((resolve, reject) => {
            okButton.onclick = () => {
                metadata.fileName = fileNameInput.value; // xxx sanitize...
                Avgrund.hide("#uploadAndShareModal");
                resolve(true);
            };
            cancelButton.onclick = () => {
                Avgrund.hide("#uploadAndShareModal");
                reject(true);
            };
        });

        let processedTheAudioFile = new Promise((resolve, reject) => {
            processAudioFile(files[0], (waveformURI, duration) => {
                console.log("processAudioFile done");
                metadata.waveformURI = waveformURI;
                metadata.duration = Math.ceil(duration);
                resolve(true);
            });
        });

        let seededTheTorrent = new Promise((resolve, reject) => {
            client.seed(files[0], (torrent) => {
                torrent.on('error', (err) => errorMessage(err.message));
                torrent.on('warning', (err) => errorMessage(err.message));
                console.log("seederClient.seed done")
                metadata.magnetURI = torrent.magnetURI
                resolve(true);
            });
        });

        Promise.all([promptedTheUser, processedTheAudioFile, seededTheTorrent]).then(() => {
            console.log("promise.all complete");
            //console.log(JSON.stringify(metadata));
            sendPayload(metadata);
        }, () => {
            console.log("Something happened.")
        });
    };

    let uploadFile = document.querySelector("input[type='file']");
    uploadFile.onchange = () => doUpload(uploadFile.files);    
    DragDrop('html', (files) => doUpload(files));

    //
    // gimmicks
    //

    // keeps timestamps up-to-date, e.g. "5 minutes ago" actually being true
    setInterval(() => {
        [].forEach.call(
            document.querySelectorAll(".createdAt"), 
            (el) => el.innerHTML = fdate(new Date(el.dataset.value))
        )
    }, 1000);

    // 10 years ago was 20 years ago
    setInterval( () => {
        let title = document.title;
        let substr = "";
        let prevCp = title.codePointAt(0);
        let prevCc = title.charCodeAt(0);
        for(let c = 1; c < title.length; c++) {
            let cp = title.codePointAt(c);
            let cc = title.charCodeAt(c);
            if( cp >= 65535 || (cp < 65535 && cp === cc && prevCp === prevCc) ){
                substr += String.fromCodePoint(cp);
            }
            prevCp = cp;
            prevCc = cc;
        }
        document.title = substr+(""["to"+(rand(0,2)?"Upper":"Lower")+"Case"].call(String.fromCodePoint(title.codePointAt(0))));
    }, 250);
});
        </script>
    </body>
</html>
