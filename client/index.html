<!doctype html>
<html>
    <head>
        <meta charset='utf-8'>
        <title>audio, freshly-squeezed ‚ô™ ‚ô´ ‚ô™ ‚ô¨üîä üçã  üçã  üçã citrus.</title>

        <!--
            CSS
        -->
        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/colors.css">
        <link rel="stylesheet" href="css/style.css">

        <!--
            JS
        -->
        <script src="dragdrop.min.js" async></script>
        <script src="webtorrent.min.js" async></script>

        <!--
            MORE JS
        -->
        <script src="waveform.js" async></script>

        <!--
            teh WebComponents rEvoLuTiOn~
        -->
        <link rel="stylesheet" href="webcomponents/dist/webcomponents.css">
        <script src="webcomponents/dist/webcomponents.js" async></script>

        <!--
            Avgrund!
        -->
        <link rel="stylesheet" href="avgrund.css">
        <script src="avgrund.js" async></script>

        <!--
            codrops!
        -->
        <link rel="stylesheet" href="css/cbutton.css">

    </head>
    <body>
        <header>
            <!--
                lemon
            -->
            <div onclick="aboutModal()" class="cbutton cbutton--effect-sanja" style="float:left;margin-top:3px;">
                <img src="lemon.svg" class="citrus__logo">
            </div>

            <!--
                upload
            -->
            <div onclick="testModal()" class="cbutton cbutton--effect-sanja" style="float:right;margin-top:16px;">
                <svg style="width:32px;height:32px;fill:#1e181a" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <path d="M54,37.7V91c0,2.2-1.8,4-4,4s-4-1.8-4-4V37.7L26.7,54.9c-1.7,1.5-4.2,1.4-5.7-0.3 s-1.3-4.2,0.3-5.6l26-23.1l2.7-2.4l2.7,2.4l26,23.1c1.7,1.5,1.8,4,0.3,5.6c-1.5,1.7-4,1.8-5.6,0.3L54,37.7L54,37.7z M76,13 c2.2,0,4-1.8,4-4s-1.8-4-4-4H24c-2.2,0-4,1.8-4,4s1.8,4,4,4H76L76,13z"/>
                    </g>
                </svg>
            </div>

            <!--
                errors
            -->
            <p id="errorMessage"></p>
        </header>

        <main class="avgrund-contents">Loading...</main>

        <footer>
            <strike>‚Ñó</strike>
        </footer>

        <!--
            supr√™me
        -->
        <template id="supr√™me">
            <article class="citrus__supr√™me">
                <div class="citrus__supr√™me-inner-row">
                    <div class="citrus__supr√™me-playpause-column play">
                        <svg class="citrus__supr√™me-playpause-button" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg" >
                            <path d="M50,0C22.4,0,0,22.4,0,50s22.4,50,50,50s50-22.4,50-50S77.6,0,50,0z M38.7,72.4V27.2l34.9,22.6L38.7,72.4z"/>
                        </svg>
                    </div>
                    <div class="citrus__supr√™me-waveform-column waveformBox not-playing">
                        <h1 class="citrus__supr√™me-title">
                            <span class="fileName"></span>
                            <time class="citrus__supr√™me-createdat-time createdAt" data-value></time>
                        </h1>
                        <div class="citrus__supr√™me-waveform-display waveformURI"></div>
                    </div>
                </div>
                <time class="citrus__supr√™me-duration-time duration" data-value></time>
            </article>
        </template>

        <!--
            share
        -->
        <template id="share">
            <aside class="avgrund-popup">
                <input required placeholder="DJ Unknown - &quot;untitled (unReleased Mix)&quot;" name="fileName">
                <textarea placeholder="shout out to you, i'm sending a shoutout to all the mofherf** in them after-hour spots..."></textarea>
                <input placeholder="#yoloswag">
                <div style="display:flex">
                    <button class="cbutton cbutton--effect-sanja">OK</button>
                    <button class="cbutton cbutton--effect-sanja">Cancel</button>
                </div>
            </aside>
        </template>

        <!--
            about
        -->
        <template id="about">
            <aside class="avgrund-popup">
                <h1>citrus.audio</h1>
                <p>freshly-squeezed</p>
            </aside>
        </template>

        <!--
            needed for Avgrund
        -->
        <div class="avgrund-cover"></div>

        <script>
// dummies
window.testModal = () => {}
window.aboutModal = () => {}

// int main(void) {
window.addEventListener("load", () => {
    
    // xxx
    window.testModal = () => {
        if(!document.getElementById("shareModal")) {
            let tpl = getTemplate("share");
            tpl.firstElementChild.setAttribute("id", "shareModal");
            document.body.appendChild(tpl);
        }
        Avgrund.show("#shareModal");
    };    
    window.aboutModal = () => {
        if(!document.getElementById("aboutModal")) {
            let tpl = getTemplate("about");
            tpl.firstElementChild.setAttribute("id", "aboutModal");
            document.body.appendChild(tpl);
        }
        Avgrund.show("#aboutModal");
    };
    //xxx

    //
    // utility functions
    //

    // stamps out a <template>
    let getTemplate = (id) => document.getElementById(id).content.cloneNode(true);

    // unique ids for things
    let q = () => parseInt(Math.pow(2,32)*Math.random(),10).toString(16);
    let uniqid = () => `uniqid-${q()+q()+q()+q()}`;

    // format date, e.g. "1 hour ago"
    let fdate = (date) => {
        let diff = ( (new Date()).getTime() - date.getTime() ) / 1000;

        let amt, unit;

        switch(true) {
        case (diff < 15):
            return 'just now!';
        case (diff > 31536000): amt = 31536000; unit = 'year'; break;
        case (diff > 2592000): amt = 2592000; unit = 'month'; break;
        case (diff > 604800): amt = 604800; unit = 'week'; break;
        case (diff > 86400): amt = 86400; unit = 'day'; break;
        case (diff > 3600): amt = 3600; unit = 'hour'; break;
        case (diff > 60): amt = 60; unit = 'minute'; break;
        case (diff > 1): unit = 'second'; break;
        default: throw new Error(diff);
        }

        let d = parseInt(diff / amt, 10);
        return `${d} ${unit}${d == 1 ? '' : 's'} ago`;
    };

    // maybe I should import a library for this instead ...
    let zeroPad = (x) => `${x < 10 ? '0' : ''}${x}`;

    // format duration, e.g. "01m:25s"
    let fduration = (s) => {
        let h = parseInt(s / 3600, 10);
        s %= 3600;
        let m = parseInt(s / 60, 10);
        s %= 60;
        return `${h > 0 ? zeroPad(h)+'h:' : ''}${zeroPad(m)}m:${zeroPad(s)}s`;
    };

    // the penguin of doom
    let rand = (min, max) => Math.floor(Math.random() * (max - min)) + min;

    //
    // they might be webcomponents
    //

    // shows red text at the top of page
    let errorMessageElement = document.getElementById("errorMessage");
    let errorMessage = (msg) => {
        console.error(msg);
        errorMessageElement.innerHTML = msg;
    };
    errorMessageElement.addEventListener("click", () => {
        errorMessageElement.innerHTML = "";
    });

    // attaches new segments 
    //xxx: needs some love
    let mainElement = document.querySelector("main");
    let leecherClient = new WebTorrent();                        
    let addChild = (data) => {

        let tpl = getTemplate("supr√™me");
        
        let articleElement = tpl.querySelector('article');
        let fileName = tpl.querySelector('.fileName');
        //let magnetURI = tpl.querySelector('.magnetURI');
        let waveformURI = tpl.querySelector('.waveformURI');
        let duration = tpl.querySelector('.duration');
        let createdAt = tpl.querySelector('.createdAt');
        let playbutton = tpl.querySelector('.play'); 
        let waveformBox = tpl.querySelector('.waveformBox');
        
        let uuid = uniqid();
        articleElement.setAttribute("id", uuid);

        playbutton.addEventListener("click", (function(magnetURI){
            return (evt) => {
                leecherClient.add(magnetURI, (torrent) => {
                    torrent.files[0].appendTo(`#${uuid}`);
                });
            };
        })(data.magnetURI) );

        playbutton.addEventListener("click", () => {
            waveformBox.classList.toggle('not-playing');
            waveformBox.classList.toggle('playing');
        });

        fileName.innerHTML = data.fileName;

        let created = new Date(data.createdAt);
        createdAt.innerHTML = fdate(created);
        createdAt.dataset.value = data.createdAt;

        duration.innerHTML = fduration(data.duration);
        duration.dataset.value = data.duration;

        waveformURI.style.backgroundImage = "url(" + data.waveformURI + ")";

        mainElement.appendChild(tpl);
        
        mainElement.querySelector(`#${uuid} .waveformURI`).innerHTML = `<input-range style="height:128px" max="${data.duration}"></input-range>`;
    };

    //
    // websocket
    //

    mainElement.innerHTML = "Opening websocket...";
    window.addEventListener("WebSocketReady", () => mainElement.innerHTML = "");

    let sendPayload;
    let wsError = () => {
        errorMessage("Couldn't connect to websocket.");
        mainElement.innerHTML = "x_x";
    };
    try {
        let ws = new WebSocket("ws://" + location.host + ":12345/");
        ws.onopen = () => {
            sendPayload = (data) => ws.send(JSON.stringify(data));
            window.dispatchEvent(new Event("WebSocketReady"));
        };
        ws.onmessage = (evt) => addChild(JSON.parse(evt.data));
        ws.onerror = (evt) => wsError()
    } catch(err) {
        console.error(err.message);
        wsError();
    }

    //
    // magic
    //

    let seederClient = new WebTorrent();
    DragDrop('html', (files) => {

        let metadata = {
            fileName: "",
            magnetURI: "",
            waveformURI: "",
            duration: 0
        };

        let processedTheAudioFile = new Promise((resolve, reject) => {
            processAudioFile(files[0], (waveformURI, duration) => {
                console.log("processAudioFile done");
                metadata.waveformURI = waveformURI;
                metadata.duration = Math.ceil(duration);
                resolve(true);
            });
        });

        let seededTheTorrent = new Promise((resolve, reject) => {
            seederClient.seed(files, (torrent) => {
                console.log("seederClient.seed done")
                metadata.magnetURI = torrent.magnetURI
                resolve(true);
            });
        });

        //xxx

        Promise.all([processedTheAudioFile, seededTheTorrent]).then(() => {
            console.log("promise.all complete");
            //console.log(JSON.stringify(metadata));
            sendPayload(metadata);
        });
    });

    //
    // gimmicks
    //

    // keeps timestamps up-to-date, e.g. "5 minutes ago" actually being true
    setInterval(() => {
        [].forEach.call(
            document.querySelectorAll(".createdAt"), 
            (el) => el.innerHTML = fdate(new Date(el.dataset.value))
        )
    }, 1000);

    // 10 years ago was 20 years ago
    setInterval( () => {
        let title = document.title;
        let substr = "";
        let prevCp = title.codePointAt(0);
        let prevCc = title.charCodeAt(0);
        for(let c = 1; c < title.length; c++) {
            let cp = title.codePointAt(c);
            let cc = title.charCodeAt(c);
            if( cp >= 65535 || (cp < 65535 && cp === cc && prevCp === prevCc) ){
                substr += String.fromCodePoint(cp);
            }
            prevCp = cp;
            prevCc = cc;
        }
        document.title = substr+(""["to"+(rand(0,2)?"Upper":"Lower")+"Case"].call(String.fromCodePoint(title.codePointAt(0))));
    }, 250);
});
        </script>
    </body>
</html>
