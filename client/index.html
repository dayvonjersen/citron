<!doctype html>
<html>
    <head>
        <meta charset='utf-8'>
        <link rel="icon" href="data:;base64,iVBORw0KGgo=">
        <script>(navigator.userAgent.indexOf("Trident")!=-1||navigator.userAgent.indexOf("Edge")!=-1||navigator.userAgent.indexOf("MSIE")!=-1)&&((window.location="http://www.getfirefox.com")&&document.writeln("here's a nickel, kid. go buy yourself a real web browser.<xmp style='display:none'>"))</script>
        <title>audio, freshly-squeezed ‚ô™ ‚ô´ ‚ô™ ‚ô¨üîä üçã  üçã  üçã citrus.</title>

        <!--
            CSS
        -->
        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/colors.css">
        <link rel="stylesheet" href="css/style.css">

        <!--
            JS
        -->
        <script src="js/dragdrop.min.js" async></script>
        <!-- <script src="js/webtorrent.min.js" async></script> -->
        <script src="js/webtorrent.debug.js" async></script>
        <script src="js/keymaster.min.js" async></script>

        <!--
            MORE JS
        -->
        <script src="js/waveform.js" async></script>

        <!--
            Avgrund!
        -->
        <link rel="stylesheet" href="css/avgrund.css">
        <script src="js/avgrund.js" defer></script>

        <!--
            codrops!
        -->
        <link rel="stylesheet" href="css/cbutton.css">

        <!--
            ana tudor!
        -->
        <link rel="stylesheet" href="css/input-type-range.css">
    </head>
    <body>
        <noscript><FONT COLOR=GRAY><I>This page intentionally left broken.</I><xmp>
                    <!--// JOIN THE TWENTY-FIRST CENTURY, GRAMPS.--> 
        </noscript>

        <header>
            <div style="display:flex;align-items:center">
                <!--
                    lemon
                -->
                <div style="flex:0 1;">
                    <div onclick="aboutModal()" class="cbutton cbutton--effect-sanja" style="margin-top:3px;">
                        <img src="svg/lemon.svg" class="citrus__logo">
                    </div>
                </div>

                <div style="flex:1;align-self:flex-start">
                    <!--
                        scary red text
                    -->
                    <p id="errorMessage"></p>
                </div>

                <div style="flex:0 1;">
                    <!--
                    arrow
                    -->
                    <label class="cbutton cbutton--effect-sanja" style="margin-top:-16px;">
                        <svg style="width:32px;height:32px;fill:#1e181a" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <g>
                                <path d="M54,37.7V91c0,2.2-1.8,4-4,4s-4-1.8-4-4V37.7L26.7,54.9c-1.7,1.5-4.2,1.4-5.7-0.3 s-1.3-4.2,0.3-5.6l26-23.1l2.7-2.4l2.7,2.4l26,23.1c1.7,1.5,1.8,4,0.3,5.6c-1.5,1.7-4,1.8-5.6,0.3L54,37.7L54,37.7z M76,13 c2.2,0,4-1.8,4-4s-1.8-4-4-4H24c-2.2,0-4,1.8-4,4s1.8,4,4,4H76L76,13z"/>
                            </g>
                        </svg>
                        <input id="uploadButton" type="file" accept="audio/*" style="display:none">
                    </label>
                </div>
            </div>
        </header>

        <main class="avgrund-contents"><center>Loading...</center></main>

        <footer>
            <!--
                knob
            -->
            <input type="range" style="position:absolute" class="citrus__volume" title="adjust volume" min="0" max="100" step="1" value="75">
            <span style="float:right" title="upload speed">&uarr; <span class="clientUpload">0 B/s</span>&emsp;</span>
            <span style="float:right;display:inline-block;padding:0 1em" title="download speed">&darr; <span class="clientDownload">0 B/s</span></span>
        </footer>

        <!--
            supr√™me
        -->
        <template id="supr√™me">
            <article class="citrus__supr√™me citrus__supr√™me--paused citrus__supr√™me--not-loaded">
                <div class="citrus__supr√™me-inner-row">
                    <div class="citrus__supr√™me-playpause-column">
                        <svg class="citrus__supr√™me-playpause-button play" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg" >
                            <path d="M50,0C22.4,0,0,22.4,0,50s22.4,50,50,50s50-22.4,50-50S77.6,0,50,0z M38.7,72.4V27.2l34.9,22.6L38.7,72.4z"/>
                        </svg>
                        <svg class="citrus__supr√™me-playpause-button pause" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50,0C22.4,0,0,22.4,0,50s22.4,50,50,50s50-22.4,50-50S77.6,0,50,0z M45,72.4H33V27.2h12V72.4z M67,72.4H55 V27.2h12V72.4z"/>
                        </svg>
                        <svg class="citrus__supr√™me-playpause-button loading" viewBox="0 0 32 32" version="1.1" x="0px" y="0px" xmlns="http://www.w3.org/2000/svg">
                            <g transform="translate(0,-1020.3622)">
                                <path d="M 16 0 A 16 16 0 0 0 0 16 A 16 16 0 0 0 16 32 A 16 16 0 0 0 32 16 A 16 16 0 0 0 16 0 z M 11.400391 14.849609 A 1.15 1.15 0 0 1 12.550781 16 A 1.15 1.15 0 0 1 11.400391 17.150391 A 1.15 1.15 0 0 1 10.25 16 A 1.15 1.15 0 0 1 11.400391 14.849609 z M 16 14.849609 A 1.15 1.15 0 0 1 17.150391 16 A 1.15 1.15 0 0 1 16 17.150391 A 1.15 1.15 0 0 1 14.849609 16 A 1.15 1.15 0 0 1 16 14.849609 z M 20.599609 14.849609 A 1.15 1.15 0 0 1 21.75 16 A 1.15 1.15 0 0 1 20.599609 17.150391 A 1.15 1.15 0 0 1 19.449219 16 A 1.15 1.15 0 0 1 20.599609 14.849609 z" transform="translate(0,1020.3622)" fill-opacity="1" fill-rule="evenodd"/>
                            </g>
                        </svg>
                    </div>
                    <div class="citrus__supr√™me-waveform-column">
                        <h1 class="citrus__supr√™me-title">
                            <a href="#" class="magnetURI">
                                <img src="svg/magnet.svg">
                                <span class="fileName"></span>
                            </a>
                            <time class="citrus__supr√™me-createdat-time createdAt" data-value></time>
                        </h1>
                        <div class="waveformBox" style="position:relative;overflow:hidden;white-space:nowrap;width:100%">
                            <!-- left: position + "%"; -->
                            <div data-style-property="left" style="position:absolute;left:0%;height:100%;">
                                <div class="slider"></div>
                            </div>

                            <!-- left: (position - 100) + "%"; -->
                            <div data-style-property="left" data-invert-position="1" style="display:inline-block;width:100%;position:relative;vertical-align:bottom;left:0%;overflow:hidden">
                                <!-- right: (position - 100) + "%"; -->
                                <div data-style-property="right" data-invert-position="1" style="position:relative;right:0%;text-align:center">
                                    <!-- "top" image -->
                                    <img class="waveform--yellow">
                                </div>
                            </div>

                            <!-- left: (position - 100) + "%"; -->
                            <div data-style-property="left" data-invert-position="1" style="display:inline-block;width:100%;position:relative;vertical-align:bottom;left:0%;overflow:hidden">
                                <!-- right: position + "%"; -->
                                <div data-style-property="right" style="position:relative;right:0%;text-align:center">
                                    <!-- "bottom" image -->
                                    <img class="waveform--black">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="citrus__supr√™me-info"><small class="torrent">(0 peers online)</small><time class="duration" data-value></time></div>
            </article>
        </template>

        <!--
            share
        -->
        <template id="uploadAndShare">
            <aside class="avgrund-popup">
                <input autofocus required placeholder="DJ Unknown - &quot;untitled (unReleased Mix)&quot;" name="fileName">
                <!-- <textarea disabled placeholder="shout out to you, i'm sending a shoutout to all the mofherf** in them after-hour spots..."></textarea> -->
                <!-- <input disabled placeholder="#yoloswag"> -->
                <div style="display:flex">
                    <button class="ok cbutton cbutton--effect-sanja">OK</button>
                    <button class="cancel cbutton cbutton--effect-sanja">Cancel</button>
                </div>
            </aside>
        </template>

        <!--
            about
        -->
        <template id="about">
            <aside class="avgrund-popup">
                <h1>citrus.audio</h1>
                <p>freshly-squeezed</p>
            </aside>
        </template>

        <!--
            needed for Avgrund
        -->
        <div class="avgrund-cover"></div>

        <script>
// dummies
window.aboutModal = () => {}

// int main(void) {
window.addEventListener("load", () => {
    //
    // touch the DOM inappropriately
    //
    document.body.removeChild(document.querySelector('noscript'));
    [].forEach.call(document.querySelectorAll('.cbutton'), (buttonElement) => {
        buttonElement.addEventListener("click", () => {
            buttonElement.classList.add("cbutton--click");
            setTimeout(()=>buttonElement.classList.remove("cbutton--click"),1250);
        });
    });

    //
    // utility functions
    //

    // stamps out a <template>
    let getTemplate = (id) => document.getElementById(id).content.cloneNode(true);

    // displays a box
    let openModal = (id) => {
        let modalId = id+"Modal";
        if(!document.getElementById(modalId)) {
            let tpl = getTemplate(id);
            tpl.firstElementChild.setAttribute("id", modalId);
            document.body.appendChild(tpl);
        }
        Avgrund.show("#"+modalId);
    };

    window.aboutModal = () => openModal("about");

    // unique ids for things
    let q = () => parseInt(Math.pow(2,32)*Math.random(),10).toString(16);
    let uniqid = () => `uniqid-${q()+q()+q()+q()}`;

    // format date, e.g. "1 hour ago"
    let fdate = (date) => {
        let diff = ( (new Date()).getTime() - date.getTime() ) / 1000;

        let unit = 'second';

        switch(true) {
        case (diff < 15):
            return 'just now!';
        case (diff > 31536000): diff /= 31536000; unit = 'year'; break;
        case (diff > 2592000): diff /= 2592000; unit = 'month'; break;
        case (diff > 604800): diff /= 604800; unit = 'week'; break;
        case (diff > 86400): diff /= 86400; unit = 'day'; break;
        case (diff > 3600): diff /= 3600; unit = 'hour'; break;
        case (diff > 60): diff /= 60; unit = 'minute'; break;
        }

        diff |= 0;
        return `${diff} ${unit}${diff == 1 ? '' : 's'} ago`;
    };

    // maybe I should import a library for this instead ...
    let zeroPad = (x) => `${x < 10 ? '0' : ''}${x}`;

    // format duration, e.g. "01m:25s"
    let fduration = (s) => {
        let h = parseInt(s / 3600, 10);
        s %= 3600;
        let m = parseInt(s / 60, 10);
        s %= 60;
        return `${h > 0 ? zeroPad(h)+'h:' : ''}${zeroPad(m)}m:${zeroPad(s)}s`;
    };

    // the penguin of doom
    let rand = (min, max) => Math.floor(Math.random() * (max - min)) + min;

    //
    // they might be webcomponents
    //

    // shows red text at the top of page
    let errorMessageElement = document.getElementById("errorMessage");
    window.errorMessage = (msg) => {
        console.error(msg);
        errorMessageElement.innerHTML = msg;
        errorMessageElement.classList.remove("fadeout");
        setTimeout(()=>errorMessageElement.classList.add("fadeout"),2000);
    };
    errorMessageElement.addEventListener("click", () => {
        errorMessageElement.classList.add("fadeout");
        errorMessageElement.innerHTML = "";
    });

    // waveform box
    let inAD2101WarWasBeginning = (containerElement) => {
        const minDistance = 0;
        const maxAngle = Infinity;
        const DEGREES_IN_RADIAN = 180 / Math.PI;

        let state = {
            x: NaN,
            y: NaN,
            isDragging: false,
            position: 0
        };

        function updatePosition(e) {
            if(containerElement.disabled) return;

            [].forEach.call(containerElement.querySelectorAll("[data-style-property]"), function(childElement) {
                var pos = (childElement.dataset.invertPosition ? state.position - 1 : state.position).toPrecision(6) * 100;
                childElement.style[childElement.dataset.styleProperty] = pos+"%";
            });

            if("undefined" !== typeof e)  containerElement.dispatchEvent(new Event("update"));
        };

        function takeoffeveryZig(e) {
            if(e) e.preventDefault();
            const isTouch = 'touches' in e;

            let pageX, pageY;
            if(isTouch) {
                pageX = e.touches[0].pageX;
                pageY = e.touches[0].pageY;
            } else {
                pageX = e.pageX;
                pageY = e.pageY;
            }

            state.x = pageX;
            state.y = pageY;

            document.addEventListener('mousemove', moveZig);
            document.addEventListener('touchmove', moveZig);
            document.addEventListener('mouseup', forgreatJustice);
            document.addEventListener('touchend', forgreatJustice);
        };

        function moveZig(e) {
            const isTouch = 'touches' in e;

            let pageX, pageY;
            if(isTouch) {
                pageX = e.touches[0].pageX;
                pageY = e.touches[0].pageY;
            } else {
                pageX = e.pageX;
                pageY = e.pageY;
            }

            if(!state.isDragging && isTouch) {
                const dx = state.x - pageX;
                const dy = state.y - pageY;

                const angle = Math.atan(dy/dx) * DEGREES_IN_RADIAN;
                const distance = Math.sqrt(dx * dx + dy * dy);

                let isDragging = distance >= minDistance;
                if(isDragging && Math.abs(angle) > maxAngle) {
                    // They're trying to scroll vertically
                    forgreatJustice();
                    return;
                } else if(!isDragging) {
                    return;
                }
                state.isDragging = isDragging;
            }

            const rect = containerElement.getBoundingClientRect();
            state.position = Math.max(Math.min( ((pageX - rect.left) / rect.width) , 1), 0);
            updatePosition(e);
        };

        function forgreatJustice() {    
            document.removeEventListener('mousemove', moveZig);
            document.removeEventListener('touchmove', moveZig);
            document.removeEventListener('mouseup', forgreatJustice);
            document.removeEventListener('touchend', forgreatJustice);

            state.isDragging = false;
            state.x = NaN;
            state.y = NaN;
            updatePosition();
        };

        function youknowwhatyoudoing(e) {
            takeoffeveryZig(e);
            moveZig(e);
        };

        containerElement.ondragstart = takeoffeveryZig;
        containerElement.ontouchstart = youknowwhatyoudoing;
        containerElement.onmousedown = youknowwhatyoudoing;
        containerElement.ondrag = moveZig;
        containerElement.ondragend = forgreatJustice;
        containerElement.ontouchend = forgreatJustice;
        containerElement.onmouseup = forgreatJustice;

        // set position to 0 on init
        updatePosition();

        // provide hooks to get/set position externally
        containerElement.getPosition = () => state.position;
        containerElement.setPosition = (p) => {
            state.position = p;
            updatePosition();
        };
    };

    let mainElement = document.querySelector("main");
    let volumeElement = document.querySelector("input[type='range']");
    let selectedAudioElement = null;
    volumeElement.addEventListener("input", () => {
        if(!selectedAudioElement)  return;
        selectedAudioElement.volume = volumeElement.value / 100
    });
    let previousVolume = volumeElement.value;
    // XXX only global for debugging
    window.client = new WebTorrent();

    // audio files
    let addChild = (data, insertBefore=true) => {

        let fileName = data.fileName;
        let magnetURI = data.magnetURI;
        let waveformURI = data.waveformURI;
        let duration = data.duration;
        let createdAt = data.createdAt;

        let tpl = getTemplate("supr√™me");

        let articleElement = tpl.querySelector('article');
        let fileNameElement = tpl.querySelector('.fileName');
        let magnetURIElement = tpl.querySelector('.magnetURI');
        let waveformURIElement = tpl.querySelector('.waveformURI');
        let durationElement = tpl.querySelector('.duration');
        let createdAtElement = tpl.querySelector('.createdAt');
        let playpauseElement = tpl.querySelector('.citrus__supr√™me-playpause-column'); 
        let waveformBoxElement = tpl.querySelector('.waveformBox');

        let uuid = uniqid();
        articleElement.setAttribute("id", uuid);

        let nevermind = false;
        playpauseElement.addEventListener("click", (evt) => {
            if(articleElement.classList.contains("citrus__supr√™me--loading")) {
                articleElement.classList.remove("citrus__supr√™me--loading");
                nevermind = true;
                return;
            }

            let audioElement = articleElement.querySelector("audio");
            [].forEach.call(document.querySelectorAll("audio"), (otherAudioElement) => {
                if(!!audioElement && otherAudioElement !== audioElement) {
                    otherAudioElement.pause();
                    otherAudioElement.removeAttribute("selected");
                }
            });
            if(!audioElement) {
                articleElement.classList.add("citrus__supr√™me--loading");
                let readyFn = (err, audioElement) => {
                    if(nevermind) return;
                    articleElement.classList.remove("citrus__supr√™me--paused");
                    articleElement.classList.remove("citrus__supr√™me--not-loaded");
                    articleElement.classList.remove("citrus__supr√™me--loading");
                    waveformBoxElement.disabled = false;
                    if(err) {
                        errorMessage(err.message);
                        return;
                    }

                    audioElement.setAttribute("selected","");
                    selectedAudioElement = audioElement;
                    audioElement.volume = volumeElement.value / 100;

                    audioElement.addEventListener("pause", () => {
                        articleElement.classList.add("citrus__supr√™me--paused");
                    });
                    audioElement.addEventListener("play", () => {
                        articleElement.classList.remove("citrus__supr√™me--paused")
                    });

                    audioElement.addEventListener("timeupdate", () => {
                        waveformBoxElement.setPosition(audioElement.currentTime / duration);
                    });

                    waveformBoxElement.addEventListener("update", () => {
                        audioElement.currentTime = duration * waveformBoxElement.getPosition();
                    });
                };
                let loaded = false;
                for(let i = 0; i < client.torrents.length; i++) {
                    if(client.torrents[i].magnetURI === magnetURI) {
                        if(!client.torrents[i].files.length) {
                            client.remove(client.torrents[i].infoHash);
                        } else {
                            client.torrents[i].files[0].appendTo(`#${uuid}`, readyFn);
                            loaded = true;
                        }
                        break;
                    }
                } 
                if(!loaded) {
                    client.add(magnetURI, (torrent) => {
                        torrent.files[0].appendTo(`#${uuid}`, readyFn);
                    });
                }
            } else if(!waveformBoxElement.classList.contains("not-loaded")) {
                audioElement.setAttribute("selected","");
                selectedAudioElement = audioElement;
                if(audioElement.paused) {
                    audioElement.play();
                } else {
                    audioElement.pause();
                }
            }        
        });
 
        fileNameElement.innerHTML = fileName;
        magnetURIElement.href = magnetURI;

        let createdAtDate = new Date(createdAt);
        createdAtElement.innerHTML = fdate(createdAtDate);
        createdAtElement.dataset.value = createdAt;
        createdAtElement.setAttribute("title", createdAtDate.toLocaleString());

        durationElement.innerHTML = fduration(duration);
        durationElement.dataset.value = duration;

        new Promise((resolve) => {
            resolve({
                yellow: getWaveformDataURI(waveformURI, duration, "#fef200"),
                black:  getWaveformDataURI(waveformURI, duration, "#1e181a")
            });
        }).then((waveformImages) => {
            waveformBoxElement.querySelector('.waveform--yellow').src = waveformImages.yellow;
            waveformBoxElement.querySelector('.waveform--black').src  = waveformImages.black;
            inAD2101WarWasBeginning(waveformBoxElement);
            waveformBoxElement.disabled = true;
        });

        if(insertBefore) {
            mainElement.insertBefore(tpl, mainElement.firstChild);
            // scroll into view if nothing is playing right now
            let audioElement = document.querySelector("audio[selected]");
            if(!audioElement || audioElement.paused) {
                mainElement.scrollTop = 0;
            }
        } else {
            mainElement.appendChild(tpl);
        }
        mainElement.removeAttribute("empty");
    };

    //
    // easter came early
    //
    const quotes = [
        `What&rsquo;s lemonade? Something you make out of lemons. And what&rsquo;s a crusade? Something you make out of crosses&mdash;a course of gratuitous violence motivated by an obsession with unanalyzed symbols.`,
        `I believe that if life gives you lemons, you should make lemonade... and try to find somebody whose life has given them vodka, and have a party.`,
        `Luther had passed many a white church in his day, heard them singing their hymns and chanting their &ldquo;Amens&rdquo; and seen them gather on a porch or two afterward with their lemonade and piety, but he knew if he ever showed up on their steps, starving or injured, the only response he&rsquo;d get to a plea for human kindness would be the amen of a shotgun pointed in his face.`,
        `The more we have known of the really good things, the more insipid the thin lemonade of later literature becomes, sometimes almost to the point of making us sick. Do you know a work of literature written in the last, say, fifteen years that you think has any lasting quality? I don&rsquo;t. It is partly idle chatter, partly propaganda, partly self-pitying sentimentality, but there is no insight, no ideas, no clarity, no substance and almost always the language is bad and constrained. On this subject I am quite consciously a laudator temporis acti.`,
        `At my lemonade stand I used to give the first glass away free and charge five dollars for the second glass. The refill contained the antidote.`,
        `We go old-school during the summer, like swimming or setting up lemonade stands. I try to teach my kids to make their own fun.`,
        `You picked a lemon, throw it away lemonade is overrated. Freaks should remain at the circus, not in your apartment. You already have one asshole. You don&rsquo;t need another. Make a space in your life for the glorious things you deserve. Have faith.`,
        `We are living in a world today where lemonade is made from artificial flavors and furniture polish is made from real lemons.`,
        `But the fool does the exact opposite. If he finds that life has handed him a lemon, he gives up and says: &ldquo;I&rsquo;m beaten. It is fate. I haven&rsquo;t got a chance.&rdquo; Then he proceeds to rail against the world and indulge in an orgy of self-pity. But when the wise man is handed a lemon, he says: &ldquo;What lesson can I learn from this misfortune? How can I improve my situation?&rdquo;`,
        `Instead of a Lemonade Stand, I should open up a &ldquo;You know what I can&rsquo;t stand?&rdquo; Stand. I&rsquo;ll sell rants in small, medium, and large.`,
        `&ldquo;B-but, Mr Jimson, I w-want to be an artist.&rdquo; &ldquo;Of course you do,&rdquo; I said, &ldquo;everybody does once. But they get over it, thank God, like the measles and the chickenpox. Go home and go to bed and take some hot lemonade and put on three blankets and sweat it out.&rdquo; &ldquo;But Mr J-Jimson, there must be artists.&rdquo; &ldquo;Yes, and lunatics and lepers, but why go and live in an asylum before you&rsquo;re sent for? If you find life a bit dull at home,&rdquo; I said, &ldquo;and want to amuse yourself, put a stick of dynamite in the kitchen fire, or shoot a policeman. Volunteer for a test pilot, or dive off Tower Bridge with five bob&rsquo;s worth of roman candles in each pocket. You&rsquo;d get twice the fun at about one-tenth of the risk.&rdquo;`,
    ];

    mainElement.setAttribute("empty", "");
    window.addEventListener("WebSocketReady", () => {
        mainElement.innerHTML = `<label for="uploadButton" class="hiddenMessage"><em>${quotes[Math.random()*quotes.length|0]}</em></label>`;
    });

    //
    // websocket
    //

    mainElement.innerHTML = "Opening websocket...";
    let isLoading = true; // used way later
    let startIndex = 0;   // for infinite scroll , ctrl+f for "onscroll" 
    let reachedEnd = false;
    let sendPayload;
    let wsError = () => {
        errorMessage("Couldn't connect to websocket.");
        mainElement.innerHTML = "x_x";
    };
    let connectionAttempts = 0;
    let connectWebsocket = () => {
        if(connectionAttempts > 5) {
            wsError();
            return;
        }
        try {
            let ws = new WebSocket("wss://" + location.host + ":12345/");
            ws.onopen = () => {
                sendPayload = (event,message) => {
                    let payload = JSON.stringify({event:event,message:message});
                    console.log(payload);
                    ws.send(payload);
                };
                window.dispatchEvent(new Event("WebSocketReady"));
            };
            ws.onmessage = (evt) => {
                let data;
                try {
                    data = JSON.parse(evt.data);
                    if(!data.event && !data.message) throw new Error();
                } catch(e) {
                    errorMessage("Malformed JSON response:"+JSON.stringify(evt.data));
                }
                if(!data) return;

                switch(data.event) {
                case "supr√™me":
                    addChild(data.message);
                    break;
                case "infinitescroll":
                    addChild(data.message, false);
                    break;
                case "loaded":
                    isLoading = false;
                    console.log("loaded:"+data.message);
                    startIndex += data.message|0;
                    if(data.message == 0) {
                        reachedEnd = true;
                    }
                    break;
                case "error":
                    errorMessage(data.message);
                    break;
                // case "eof" maybe?
                }
            };
            ws.onerror = (evt) => wsError();
            ws.onclose = (evt) => connectWebsocket();    
        } catch(err) {
            console.error(err.message);
            wsError();
        }
        connectionAttempts++;
    };
    connectWebsocket();

    //
    // add torrents
    //

    const validMimetypes = /^audio\/(x\-)?((mp((e)?g(audio|3)?|3))|wav|ogg)$/;

    let doUpload = function(files) {

        if(!files.length) return;
        if(files.length > 1) {
            errorMessage("One file at a time, please!");
            return;
        }

        if("video/ogg" !== files[0].type && !validMimetypes.test(files[0].type)) {
            errorMessage(`MP3, OGG, or WAV only! Yell at ${ "chrome" in window ? "google" : "mozApps" in navigator ? "mozilla" : "whoever makes your browser" } to support ${files[0].type}`);
            return;
        }
        
        openModal("uploadAndShare");

        let uploadAndShareModal = document.querySelector("#uploadAndShareModal");
        let fileNameInput = uploadAndShareModal.querySelector("input[name='fileName']");
        let okButton = uploadAndShareModal.querySelector("button.ok");
        let cancelButton = uploadAndShareModal.querySelector("button.cancel");

        fileNameInput.value = files[0].name.split(".").reverse().filter((v,k)=>k).reverse().join(".") || "";

        setTimeout(()=>fileNameInput.focus(), 500);

        let metadata = {
            fileName: "",
            magnetURI: "",
            waveformURI: "",
            duration: 0
        };

        let promptedTheUser = new Promise((resolve, reject) => {
            okButton.onclick = () => {
                metadata.fileName = fileNameInput.value; // xxx sanitize...
                Avgrund.hide("#uploadAndShareModal");
                resolve(true);
            };
            cancelButton.onclick = () => {
                Avgrund.hide("#uploadAndShareModal");
                reject(true);
            };
        });

        let processedTheAudioFile = new Promise((resolve, reject) => {
            processAudioFile(files[0], (waveformURI, duration) => {
                console.log("processAudioFile done");
                metadata.waveformURI = waveformURI;
                metadata.duration = Math.ceil(duration);
                resolve(true);
            });
        });

        let seededTheTorrent = new Promise((resolve, reject) => {
            client.seed(files[0], (torrent) => {
                torrent.on('error', (err) => errorMessage(err.message));
                torrent.on('warning', (err) => errorMessage(err.message));
                console.log("seederClient.seed done")
                metadata.magnetURI = torrent.magnetURI
                resolve(true);
            });
        });

        Promise.all([promptedTheUser, processedTheAudioFile, seededTheTorrent]).then(() => {
            console.log("promise.all complete");
            //console.log(JSON.stringify(metadata));
            sendPayload("supr√™me",metadata);
            //metadata.createdAt=new Date;
            //addChild(metadata);
        }, () => {
            console.log("Something happened.")
        });
    };

    let uploadFile = document.querySelector("input[type='file']");
    uploadFile.onchange = () => doUpload(uploadFile.files);    
    DragDrop('html', (files) => doUpload(files));

    //
    // gimmicks
    //

    // ul/dl speeds
    let clientUpload = document.querySelector('.clientUpload');
    let clientDownload = document.querySelector('.clientDownload');
    let formatBytes = (b) => {
        b |= 0;
        let u = '';
        switch(true) {
        case (b >= 1000 && b < 1000000): u = 'K'; b/=1000; break;
        case (b >= 1000000 && b < 1000000000): u = 'M'; b/=1000000; break;
        case (b > 1000000000): u = 'G'; b/=1000000000; break;
        }
        return `${b.toPrecision(3).replace(/[0\.]+$/,'') || "0"} ${u}B/s`;
    };
    setInterval(() => {
        clientUpload.innerHTML = formatBytes(client.uploadSpeed);
        clientDownload.innerHTML = formatBytes(client.downloadSpeed);
    }, 1000);

    // keeps timestamps up-to-date, e.g. "5 minutes ago" actually being true
    setInterval(() => {
        [].forEach.call(
            document.querySelectorAll(".createdAt"), 
            (el) => el.innerHTML = fdate(new Date(el.dataset.value))
        )
    }, 1000);

    // 10 years ago was 20 years ago
    setInterval( () => {
        let title = document.title;
        let substr = "";
        let prevCp = title.codePointAt(0);
        let prevCc = title.charCodeAt(0);
        for(let c = 1; c < title.length; c++) {
            let cp = title.codePointAt(c);
            let cc = title.charCodeAt(c);
            if( cp >= 65535 || (cp < 65535 && cp === cc && prevCp === prevCc) ){
                substr += String.fromCodePoint(cp);
            }
            prevCp = cp;
            prevCc = cc;
        }
        document.title = substr+(""["to"+(rand(0,2)?"Upper":"Lower")+"Case"].call(String.fromCodePoint(title.codePointAt(0))));
    }, 250);

    //
    // ~infinite scroll~
    //

    const perimeter = 400;      // "padding" or "buffer area" before absolute bottom of scroll
    let lastScrollDistance = 0;
    mainElement.onscroll = () => {
        if(mainElement.scrollTop === 0) {
            mainElement.style.boxShadow = "none";
        } else {
            // box shadows on headers are mandatory in 2016
            mainElement.style.boxShadow = "0px 10px 10px -5px rgb(204, 204, 204) inset";

            // mainElement will resize when it gets new contents so yes this must be recalculated
            let scrollTopMax = mainElement.scrollTopMax || (mainElement.scrollHeight - mainElement.getBoundingClientRect().height);
            let scrollDistance = scrollTopMax - mainElement.scrollTop;
            if(!reachedEnd
            && scrollDistance < perimeter          // within range
            && scrollDistance < lastScrollDistance // scrolling downwards
            && !isLoading                          // don't want to spam requests
            ) {
                isLoading = true;
                sendPayload("range", {start: startIndex+1, limit: 5});
            }
            lastScrollDistance = scrollDistance;
        }
    };

    //
    // common keyboard shortcuts
    //
    key('space', (e) => {
        e.preventDefault();
        let audioElement = document.querySelector("audio[selected]");
        if(audioElement) {
            audioElement.paused ? audioElement.play() : audioElement.pause();
        }
    });
    key('s,esc', (e) => {
        e.preventDefault();
        let audioElement = document.querySelector("audio[selected]");
        if(audioElement) {
            audioElement.currentTime = 0;
            audioElement.pause();
        }
    });
    key('m', () => {
        if(volumeElement.value|0) {
            previousVolume = volumeElement.value|0;
            volumeElement.value = 0;
        } else {
            volumeElement.value = previousVolume;
        }
        volumeElement.dispatchEvent(new Event("input"));
    });
    key('ctrl+up', (e) => {
        e.preventDefault();
        volumeElement.value = Math.min(100, (volumeElement.value|0)+5);
        volumeElement.dispatchEvent(new Event("input"));
    });
    key('ctrl+down', (e) => {
        e.preventDefault();
        volumeElement.value = Math.max(0, (volumeElement.value|0)-5);
        volumeElement.dispatchEvent(new Event("input"));
    });
});
        </script>
    </body>
</html>
