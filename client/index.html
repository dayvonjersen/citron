<!doctype html>
<html>
    <head>
        <meta charset='utf-8'>
        <title>audio, freshly-squeezed ‚ô™ ‚ô´ ‚ô™ ‚ô¨üîä üçã  üçã  üçã citrus.</title>

        <!--
            CSS
        -->
        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/colors.css">
        <link rel="stylesheet" href="css/style.css">

        <!--
            JS
        -->
        <script src="dragdrop.min.js" async></script>
        <script src="webtorrent.min.js" async></script>

        <!--
            MORE JS
        -->
        <script src="waveform.js" async></script>

        <!--
            teh WebComponents rEvoLuTiOn~
        -->
        <link rel="stylesheet" href="webcomponents/dist/webcomponents.css">
        <script src="webcomponents/dist/webcomponents.js" async></script>

        <!--
            Avgrund!
        -->
        <link rel="stylesheet" href="avgrund.css">
        <script src="avgrund.js" async></script>

        <!--
            codrops!
        -->
        <link rel="stylesheet" href="css/cbutton.css">

    </head>
    <body>
        <header>
            <!--
                lemon
            -->
            <div onclick="aboutModal()" class="cbutton cbutton--effect-sanja" style="float:left;margin-top:3px;">
                <img src="lemon.svg" class="citrus__logo">
            </div>

            <!--
                upload
            -->
            <div onclick="testModal()" class="cbutton cbutton--effect-sanja" style="float:right;margin-top:16px;">
                <svg style="width:32px;height:32px;fill:#1e181a" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <path d="M54,37.7V91c0,2.2-1.8,4-4,4s-4-1.8-4-4V37.7L26.7,54.9c-1.7,1.5-4.2,1.4-5.7-0.3 s-1.3-4.2,0.3-5.6l26-23.1l2.7-2.4l2.7,2.4l26,23.1c1.7,1.5,1.8,4,0.3,5.6c-1.5,1.7-4,1.8-5.6,0.3L54,37.7L54,37.7z M76,13 c2.2,0,4-1.8,4-4s-1.8-4-4-4H24c-2.2,0-4,1.8-4,4s1.8,4,4,4H76L76,13z"/>
                    </g>
                </svg>
            </div>

            <!--
                errors
            -->
            <p id="errorMessage"></p>
        </header>

        <main class="avgrund-contents">Loading...</main>

        <footer>
            <strike>‚Ñó</strike>
        </footer>

        <!--
            supr√™me
        -->
        <template id="supr√™me">
            <article class="citrus__supr√™me">
                <div class="citrus__supr√™me-inner-row">
                    <div class="citrus__supr√™me-playpause-column play">
                        <svg class="citrus__supr√™me-playpause-button" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg" >
                            <path d="M50,0C22.4,0,0,22.4,0,50s22.4,50,50,50s50-22.4,50-50S77.6,0,50,0z M38.7,72.4V27.2l34.9,22.6L38.7,72.4z"/>
                        </svg>
                    </div>
                    <div class="citrus__supr√™me-waveform-column waveformBox not-playing">
                        <h1 class="citrus__supr√™me-title">
                            <span class="fileName"></span>
                            <time class="citrus__supr√™me-createdat-time createdAt" data-value></time>
                        </h1>
                        <div class="citrus__supr√™me-waveform-display waveformURI"></div>
                    </div>
                </div>
                <time class="citrus__supr√™me-duration-time duration" data-value></time>
            </article>
        </template>

        <template id="share">
            <aside class="avgrund-popup">
                <input required placeholder="DJ Unknown - &quot;untitled (unReleased Mix)&quot;" name="fileName">
                <textarea placeholder="shout out to you, i'm sending a shoutout to all the mofherf** in them after-hour spots..."></textarea>
                <input placeholder="#yoloswag">
                <div style="display:flex">
                    <button class="cbutton cbutton--effect-sanja">OK</button>
                    <button class="cbutton cbutton--effect-sanja">Cancel</button>
                </div>
            </aside>
        </template>
        
        <template id="about">
            <aside class="avgrund-popup">
                <h1>citrus.audio</h1>
                <p>freshly-squeezed</p>
            </aside>
        </template>

        <div class="avgrund-cover"></div>

        <script>
window.testModal = ()=>{}
window.aboutModal = ()=>{}
window.addEventListener("load", () => {

    let getTemplate = (id) => document.getElementById(id).content.cloneNode(true);

    let q = () => parseInt(Math.pow(2,32)*Math.random(),10).toString(16);
    let uniqid = () => `uniqid-${q()+q()+q()+q()}`;

    window.testModal = () => {
        if(!document.getElementById("shareModal")) {
            let tpl = getTemplate("share");
            tpl.firstElementChild.setAttribute("id", "shareModal");
            document.body.appendChild(tpl);
        }
        Avgrund.show("#shareModal");
    };
    
    window.aboutModal = () => {
        if(!document.getElementById("aboutModal")) {
            let tpl = getTemplate("about");
            tpl.firstElementChild.setAttribute("id", "aboutModal");
            document.body.appendChild(tpl);
        }
        Avgrund.show("#aboutModal");
    };

    let errorMessage = (msg) => {
        document.getElementById("errorMessage").innerHTML = msg;
    };

    errorMessage("Something happened.");

    document.getElementById("errorMessage").addEventListener("click", ()=> {
        document.getElementById("errorMessage").innerHTML = "";
    });


    let mainElement = document.querySelector("main");

    let ftime = (time, amount, unit) => {
        if(time >= amount) {
            let d = parseInt(time/amount, 10);
            return [`${d} ${unit}${d == 1 ? '' : 's'}`, parseInt(time%amount, 10)];
        } else {
            return ['', time];
        }
    };

    let fdate = (date) => {
        let diff = ( (new Date()).getTime() - date.getTime() ) / 1000;
        if(diff < 1) {
            return 'just now!';
        }

        let ret = [];
        var tmp = ftime(diff, 31536000, 'year');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 2592000, 'month');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 604800, 'week');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 86400, 'day');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 3600, 'hour');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 60, 'minute');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 1, 'second');
        ret[ret.length] = tmp[0]; 

        return ret.filter((s)=>s).shift() + " ago";
    };

    let zeroPad = (x) => `${x < 10 ? '0' : ''}${x}`;

    let fduration = (s) => {
        let h = parseInt(s / 3600, 10);
        s %= 3600;
        let m = parseInt(s / 60, 10);
        s %= 60;
        return `${h > 0 ? zeroPad(h)+':' : ''}${zeroPad(m)}:${zeroPad(s)}`;
    };

    let leecherClient = new WebTorrent();                        

    let addChild = (data) => {

        let tpl = getTemplate("supr√™me");

        let uuid = uniqid();

        let articleElement = tpl.querySelector('article');
        articleElement.setAttribute("id", uuid);

        let fileName = tpl.querySelector('.fileName');
        //let magnetURI = tpl.querySelector('.magnetURI');
        let waveformURI = tpl.querySelector('.waveformURI');
        let duration = tpl.querySelector('.duration');
        let createdAt = tpl.querySelector('.createdAt');

        let playbutton = tpl.querySelector('.play'); 
/*        playbutton.addEventListener("click", (function(magnetURI) 
            {
                return (evt) => {
                    leecherClient.add(magnetURI, (torrent) => {
                        torrent.files[0].appendTo(`#${uuid}`);
                    });
                }
            })(data.magnetURI)
            );*/
        let waveformBox = tpl.querySelector('.waveformBox');
        playbutton.addEventListener("click", () => {
            waveformBox.classList.toggle('not-playing');
            waveformBox.classList.toggle('playing');
        });
            

        fileName.innerHTML = data.fileName;

        let created = new Date(data.createdAt);
        createdAt.innerHTML = fdate(created);
        createdAt.dataset.value = data.createdAt;

        duration.innerHTML = fduration(data.duration);
        duration.dataset.value = data.duration;

        waveformURI.style.backgroundImage = "url(" + data.waveformURI + ")";

        mainElement.appendChild(tpl);
        
        mainElement.querySelector(`#${uuid} .waveformURI`).innerHTML = `<input-range style="height:128px" max="${data.duration}"></input-range>`;
    };

    /**
     * init 
     */
    mainElement.innerHTML = "Opening websocket...";

    let sendPayload;
    try {
        let ws = new WebSocket("ws://" + location.host + ":12345/");
        ws.onopen = () => {
            sendPayload = (data) => ws.send(JSON.stringify(data));
            window.dispatchEvent(new Event("WebSocketReady"));
        };
        ws.onmessage = (evt) => addChild(JSON.parse(evt.data));
    } catch(err) {
        mainElement.innerHTML = err.message
    }

    window.addEventListener("WebSocketReady", () => {

        mainElement.innerHTML = "";

    });

    let seederClient = new WebTorrent();

    DragDrop('html', (files) => {

        let metadata = {
            fileName: "",
            magnetURI: "",
            waveformURI: "",
            duration: 0
        };

        let processedTheAudioFile = new Promise((resolve, reject) => {
            processAudioFile(files[0], (waveformURI, duration) => {
                console.log("processAudioFile done");
                metadata.waveformURI = waveformURI;
                metadata.duration = Math.ceil(duration);
                resolve(true);
            });
        });

        let seededTheTorrent = new Promise((resolve, reject) => {
            seederClient.seed(files, (torrent) => {
                console.log("seederClient.seed done")
                metadata.magnetURI = torrent.magnetURI
                resolve(true);
            });
        });

        Promise.all([processedTheAudioFile, seededTheTorrent]).then(() => {
            console.log("promise.all complete");
            //console.log(JSON.stringify(metadata));
            sendPayload(metadata);
        });
    });

    setInterval(() => {
        [].forEach.call(document.querySelectorAll(".createdAt"), (createdAt) => {
            createdAt.innerHTML = fdate(new Date(createdAt.dataset.value));
        });
    }, 1000);

    let rand = (min, max) => Math.floor(Math.random() * (max - min)) + min;

    setInterval( () => {
        let substr = "";
        let prevCp = document.title.codePointAt(0);
        let prevCc = document.title.charCodeAt(0);
        for(let c = 1; c < document.title.length; c++) {
            let cp = document.title.codePointAt(c);
            let cc = document.title.charCodeAt(c);
            if( cp < 65535 && cp === cc ) {
                if( prevCp === prevCc){
                    substr += String.fromCodePoint(cp);
                }
            } else if(cp > 65535) {
                substr += String.fromCodePoint(cp);
            }
            prevCp = cp;
            prevCc = cc;
        }
        document.title = substr+(""["to"+(rand(0,2)?"Upper":"Lower")+"Case"].call(String.fromCodePoint(document.title.codePointAt(0))));
    }, 250);    

});
        </script>
    </body>
</html>
