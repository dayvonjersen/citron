<!doctype html>
<html>
    <head>
        <title>üçã CiTRON &mdash; freshly-squeezed ‚ô´</title>

        <!--
            CSS
        -->
        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/colors.css">
        <link rel="stylesheet" href="css/style.css">

        <!--
            JS
        -->
        <script src="dragdrop.min.js" async></script>
        <script src="webtorrent.min.js" async></script>

        <!--
            MORE JS
        -->
        <script src="waveform.js" async></script>

        <!--
            teh WebComponents rEvoLuTiOn~
        -->
        <link rel="stylesheet" href="webcomponents/dist/webcomponents.css">
        <script src="webcomponents/dist/webcomponents.js" async></script>

        <!--
            Avgrund!
        -->
        <link rel="stylesheet" href="avgrund.css">
        <script src="avgrund.js" async></script>

    </head>
    <body>
        <header>
            <img onclick="testModal()" src="upload.svg" style="display:inline;width:32px;height:32px;float:right;margin-top:16px;">
        </header>

        <main>Loading...</main>

        <template id="supreme">
            <article style="position:relative">
                <div style="display:flex;flex-wrap:nowrap;align-items:center">
                    <div style="flex:0 1 auto;margin-right:16px;">
<svg version="1.1" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="play">
  <path d="M50,0C22.4,0,0,22.4,0,50s22.4,50,50,50s50-22.4,50-50S77.6,0,50,0z M38.7,72.4V27.2l34.9,22.6L38.7,72.4z"/>
</svg>
                        
                    </div>
                    <div style="flex:auto">
                        <h1>
                            <span class="fileName"></span>
                            <span class="createdAt" data-value style="font-size:12px;float:right;color:#ccc"></span>
                        </h1>
                        
                        <div style="background-size:100% 100%" class="waveformURI"></div>
                    </div>
                </div>
                <time class="duration" data-value></time>
            </article>
        </template>

        <template id="modal">
            <aside class="avgrund-popup">
                <input required placeholder="DJ Unknown - &quot;untitled (unReleased Mix)&quot;">
                <textarea placeholder="shout out to you, i'm sending a shoutout to all the mofherf** in them after-hour spots"></textarea>
                <input placeholder="#yoloswag">
                <button>OK</button>
                <button>Cancel</button>
            </aside>
        </template>

        <div class="avgrund-cover"></div>

        <script>
window.testModal = ()=>{}
window.addEventListener("load", () => {

    let getTemplate = (id) => document.getElementById(id).content.cloneNode(true);

    let uniqid = function(prefix) {
        prefix = typeof(prefix) === "undefined" ? "uniqid-" : prefix.toString();
        function q() {
            return parseInt(Math.pow(2,32) * Math.random(),10).toString(16);
        }
        return prefix + q() + q() + q() + q();
    };

    window.testModal = () => {
        let tpl = getTemplate("modal");
        let uuid = uniqid();
        tpl.firstElementChild.setAttribute("id", uuid)
        document.body.appendChild(tpl);
        Avgrund.show(`#${uuid}`);
    };

    let mainElement = document.querySelector("main");

    let ftime = (time, amount, unit) => {
        if(time >= amount) {
            let d = parseInt(time/amount, 10);
            return [`${d} ${unit}${d == 1 ? '' : 's'}`, parseInt(time%amount, 10)];
        } else {
            return ['', time];
        }
    };

    let fdate = (date) => {
        let diff = ( (new Date()).getTime() - date.getTime() ) / 1000;
        if(diff < 1) {
            return 'just now!';
        }

        let ret = [];
        var tmp = ftime(diff, 31536000, 'year');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 2592000, 'month');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 604800, 'week');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 86400, 'day');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 3600, 'hour');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 60, 'minute');
        ret[ret.length] = tmp[0]; diff = tmp[1];
        tmp = ftime(diff, 1, 'second');
        ret[ret.length] = tmp[0]; 

        return ret.filter((s)=>s).join(" ") + " ago";
    };

    let zeroPad = (x) => `${x < 10 ? '0' : ''}${x}`;

    let fduration = (s) => {
        let h = parseInt(s / 3600, 10);
        s %= 3600;
        let m = parseInt(s / 60, 10);
        s %= 60;
        return `${h > 0 ? zeroPad(h)+':' : ''}${zeroPad(m)}:${zeroPad(s)}`;
    };

    let leecherClient = new WebTorrent();                        

    let addChild = (data) => {

        let tpl = getTemplate("supreme");

        let uuid = uniqid();

        let articleElement = tpl.querySelector('article');
        articleElement.setAttribute("id", uuid);

        let fileName = tpl.querySelector('.fileName');
        //let magnetURI = tpl.querySelector('.magnetURI');
        let waveformURI = tpl.querySelector('.waveformURI');
        let duration = tpl.querySelector('.duration');
        let createdAt = tpl.querySelector('.createdAt');

        let playbutton = tpl.querySelector('.play'); 
        playbutton.addEventListener("click", (function(magnetURI) 
            {
                return (evt) => {
                    leecherClient.add(magnetURI, (torrent) => {
                        torrent.files[0].appendTo(`#${uuid}`);
                    });
                }
            })(data.magnetURI)
        );

        fileName.innerHTML = data.fileName;

        let created = new Date(data.createdAt);
        createdAt.innerHTML = fdate(created);
        createdAt.dataset.value = data.createdAt;

        duration.innerHTML = fduration(data.duration);
        duration.dataset.value = data.duration;

        waveformURI.style.backgroundImage = "url(" + data.waveformURI + ")";

        mainElement.appendChild(tpl);
        
        mainElement.querySelector(`#${uuid} .waveformURI`).innerHTML = `<input-range style="height:128px" max="${data.duration}"></input-range>`;
    };

    /**
     * init 
     */
    mainElement.innerHTML = "Opening websocket...";

    let sendPayload;
    try {
        let ws = new WebSocket("ws://" + location.host + ":12345/");
        ws.onopen = () => {
            sendPayload = (data) => ws.send(JSON.stringify(data));
            window.dispatchEvent(new Event("WebSocketReady"));
        };
        ws.onmessage = (evt) => addChild(JSON.parse(evt.data));
    } catch(err) {
        mainElement.innerHTML = err.message
    }

    window.addEventListener("WebSocketReady", () => {

        mainElement.innerHTML = "";

    });

    let seederClient = new WebTorrent();

    DragDrop('html', (files) => {

        let metadata = {
            fileName: "",
            magnetURI: "",
            waveformURI: "",
            duration: 0
        };

        let processedTheAudioFile = new Promise((resolve, reject) => {
            processAudioFile(files[0], (waveformURI, duration) => {
                console.log("processAudioFile done");
                metadata.waveformURI = waveformURI;
                metadata.duration = Math.ceil(duration);
                resolve(true);
            });
        });

        let seededTheTorrent = new Promise((resolve, reject) => {
            seederClient.seed(files, (torrent) => {
                console.log("seederClient.seed done")
                metadata.magnetURI = torrent.magnetURI
                resolve(true);
            });
        });

        Promise.all([processedTheAudioFile, seededTheTorrent]).then(() => {
            console.log("promise.all complete");
            //console.log(JSON.stringify(metadata));
            sendPayload(metadata);
        });
    });

    setInterval(() => {
        [].forEach.call(document.querySelectorAll(".createdAt"), (createdAt) => {
            createdAt.innerHTML = fdate(new Date(createdAt.dataset.value));
        });
    }, 1000);

    let rand = (min, max) => Math.floor(Math.random() * (max - min)) + min;

    setInterval(() => document.title = document.title.substr(1)+(""["to"+(rand(0,2)?"Upper":"Lower")+"Case"].call(document.title[0])), 250);

});
        </script>
    </body>
</html>
